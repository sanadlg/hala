<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الموظفين - شركة حلا الدولية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Tajawal', 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-color);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .header p {
            margin: 5px 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .search-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .search-section p {
            color: #666;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }
        
        .search-input {
            min-width: 300px;
            font-size: 1.1rem;
            padding: 15px 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            transition: border 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .search-result-card {
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: right;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .search-result-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .not-found-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #856404;
        }
        
        .not-found-message h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .contact-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .contact-info h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .contact-info p {
            margin: 5px 0;
            color: #333;
        }

        .whatsapp-link {
            color: #25d366;
            text-decoration: none;
            font-weight: bold;
        }

        .whatsapp-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .search-input {
                min-width: 250px;
            font-size: 1rem;
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-users-cog"></i> نظام إدارة الموظفين</h1>
            <p>شركة حلا الدولية - إدارة شؤون العاملين</p>
        </div>
    </div>
    
    <!-- قسم البحث العام للمستخدمين -->
    <div class="container">
        <div class="search-section">
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 1.1rem;">
                <i class="fas fa-info-circle"></i> تنويه: يتم تحديث أو إضافة ساعات العمل في نهاية كل شهر فقط.
        </div>
            <h2>
                <i class="fas fa-search"></i> البحث عن ساعات العمل
            </h2>
            <p>
                اكتب اسمك في خانة البحث أدناه للاطلاع على ساعات عملك
            </p>
            
            <div style="display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                <input type="text" id="global-search" class="search-input" placeholder="اكتب اسمك هنا..." />
            </div>
            
            <div id="search-results" style="margin-top: 20px;">
                <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 20px; text-align: center; color: #2e7d32;">
                    <h3 style="margin-bottom: 10px; color: #2e7d32;">
                        <i class="fas fa-hand-wave"></i> مرحباً بك في نظام إدارة الموظفين
                    </h3>
                    <p style="margin: 0; font-size: 1.1rem;">
                        اكتب اسمك في خانة البحث أعلاه للاطلاع على ساعات عملك
                    </p>
            </div>
        </div>
            </div>
            </div>

    <script>
        // بيانات جوجل شيت
        const SHEET_ID = '14vdiTvwjUyFA3eBXxcPd3r4W3aipgUf8NhP48X8TYKk';
        const API_KEY = 'AIzaSyDz6N1Y4s7VcdC9z76xon_5sH5L-i7QqAU';
        
        // بيانات التطبيق
        let employees = [];
        let deductions = [];
        let hourlyRates = {};
        
        // تحميل البيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupEventListeners();
        });
        
        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // البحث التلقائي أثناء الكتابة (مع تأخير)
            let searchTimeout;
            document.getElementById('global-search').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        performGlobalSearch();
                    }, 500);
                } else if (query.length === 0) {
                    document.getElementById('search-results').innerHTML = `
                        <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 20px; text-align: center; color: #2e7d32;">
                            <h3 style="margin-bottom: 10px; color: #2e7d32;">
                                <i class="fas fa-hand-wave"></i> مرحباً بك في نظام إدارة الموظفين
                            </h3>
                            <p style="margin: 0; font-size: 1.1rem;">
                                اكتب اسمك في خانة البحث أعلاه للاطلاع على ساعات عملك
                            </p>
                        </div>
                    `;
                }
            });
        }
        
        // جلب جميع البيانات
        async function loadAllData() {
            try {
                console.log('بدء تحميل البيانات...');
                console.log('Sheet ID:', SHEET_ID);
                console.log('API Key:', API_KEY ? 'موجود' : 'غير موجود');
                
                if (!SHEET_ID || !API_KEY) {
                    throw new Error('بيانات الاتصال غير صحيحة. يرجى التحقق من Sheet ID و API Key');
                }
                
                await Promise.all([
                    fetchEmployeeData(),
                    fetchDeductionData(),
                    fetchHourlyRatesData()
                ]);
                
                console.log('تم تحميل جميع البيانات بنجاح');
            } catch (error) {
                console.error('Error loading data:', error);
                
                let errorMessage = 'حدث خطأ أثناء جلب البيانات: ' + error.message;
                
                if (error.message.includes('HTTP 403')) {
                    errorMessage = 'خطأ في الصلاحيات: يرجى التحقق من إعدادات Google Sheets API';
                } else if (error.message.includes('HTTP 404')) {
                    errorMessage = 'لم يتم العثور على الجدول: يرجى التحقق من Sheet ID';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'خطأ في الاتصال بالشبكة: يرجى التحقق من اتصال الإنترنت';
                }
                
                alert(errorMessage);
            }
        }
        
        // دالة بديلة لجلب البيانات باستخدام طرق متعددة
        async function fetchDataWithFallback(sheetName, range) {
            const methods = [
                async () => {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}!${range}?key=${API_KEY}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                },
                async () => {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}!${range}?key=${API_KEY}`;
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                },
                async () => {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}!${range}?key=${API_KEY}`;
                    const response = await fetch(`https://cors-anywhere.herokuapp.com/${url}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                }
            ];
            
            for (let i = 0; i < methods.length; i++) {
                try {
                    console.log(`محاولة الطريقة ${i + 1} لجلب البيانات من ${sheetName}...`);
                    return await methods[i]();
                } catch (error) {
                    console.warn(`فشلت الطريقة ${i + 1}:`, error.message);
                    if (i === methods.length - 1) throw error;
                }
            }
        }

        // جلب بيانات أسعار الساعات من جدول sa
        async function fetchHourlyRatesData() {
            try {
                const data = await fetchDataWithFallback("sa", "A:B");
                
                if (data.values && data.values.length > 1) {
                    const rows = data.values.slice(1);
                    
                    rows.forEach(row => {
                        const employeeName = row[0] || '';
                        const hourlyRate = parseFloat(row[1]) || 3.33;
                        
                        if (employeeName.trim()) {
                            hourlyRates[employeeName.trim()] = hourlyRate;
                        }
                    });
                }
            } catch (error) {
                console.warn('Error fetching hourly rates data:', error);
            }
        }
        
        // جلب بيانات الموظفين من جوجل شيت
        async function fetchEmployeeData() {
            try {
                const data = await fetchDataWithFallback("mowdf", "A:E");
                
                if (!data.values || data.values.length <= 1) {
                    throw new Error('لا توجد بيانات في جدول الموظفين');
                }
                
                const headers = data.values[0];
                const rows = data.values.slice(1);
                
                const employeesMap = {};
                
                rows.forEach(row => {
                    const name = row[0] || 'غير معروف';
                    if (!employeesMap[name]) {
                        employeesMap[name] = {
                            name: name,
                            attendance: [],
                            deductions: []
                        };
                    }
                    
                    employeesMap[name].attendance.push({
                        date: row[1] || '',
                        checkIn: row[2] || '',
                        checkOut: row[3] || '',
                        totalHours: calculateHours(row[2], row[3])
                    });
                });
                
                employees = Object.values(employeesMap);
                
            } catch (error) {
                console.error('Error fetching employee data:', error);
                throw error;
            }
        }
        
        // جلب بيانات الخصومات من جوجل شيت
        async function fetchDeductionData() {
            try {
                const data = await fetchDataWithFallback("kasm", "A:D");
                
                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    
                    deductions = rows.map(row => {
                        return {
                            employeeName: row[0] || '',
                            amount: parseFloat(row[1] || 0).toFixed(3),
                            reason: row[2] || '',
                            date: row[3] || ''
                        };
                    });

                    employees.forEach(employee => {
                        employee.deductions = deductions.filter(d => 
                            d.employeeName && employee.name && 
                            d.employeeName.trim() === employee.name.trim()
                        );
                    });
                }
            } catch (error) {
                console.warn('Error fetching deduction data:', error);
            }
        }
        
        // حساب ساعات العمل
        function calculateHours(checkIn, checkOut) {
            if (!checkIn || !checkOut) return 0;
            
            try {
                const [inTimePart, inPeriod] = checkIn.split(' ');
                const [inHour, inMin, inSec] = inTimePart.split(':').map(Number);
                
                let inHours24 = inHour;
                if (inPeriod === 'م' && inHour !== 12) {
                    inHours24 += 12;
                } else if (inPeriod === 'ص' && inHour === 12) {
                    inHours24 = 0;
                }
                
                const [outTimePart, outPeriod] = checkOut.split(' ');
                const [outHour, outMin, outSec] = outTimePart.split(':').map(Number);
                
                let outHours24 = outHour;
                if (outPeriod === 'م' && outHour !== 12) {
                    outHours24 += 12;
                } else if (outPeriod === 'ص' && outHour === 12) {
                    outHours24 = 0;
                }
                
                const totalMinutesIn = inHours24 * 60 + inMin + inSec / 60;
                const totalMinutesOut = outHours24 * 60 + outMin + outSec / 60;
                
                let diffMinutes = totalMinutesOut - totalMinutesIn;
                
                if (diffMinutes < 0) {
                    diffMinutes += 24 * 60;
                }
                
                return diffMinutes / 60;
            } catch (error) {
                console.warn('Error calculating hours:', error);
                return 0;
            }
        }
        
        // تنسيق الساعات
        function formatHours(hours) {
            if (hours === 0) return '0 ساعة';
            
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            
            let result = '';
            if (wholeHours > 0) {
                result += `${wholeHours} ساعة`;
            }
            if (minutes > 0) {
                if (result) result += ' و ';
                result += `${minutes} دقيقة`;
            }
            
            return result;
        }
        
        // دالة البحث العام
        function performGlobalSearch() {
            const searchQuery = document.getElementById('global-search').value.trim();
            const resultsContainer = document.getElementById('search-results');
            
            if (!searchQuery) {
                resultsContainer.innerHTML = '<div class="not-found-message"><h3>يرجى إدخال اسم للبحث</h3></div>';
                return;
            }
            
            const employee = employees.find(emp => {
                const empName = emp.name.toLowerCase();
                const query = searchQuery.toLowerCase();
                
                if (empName === query) return true;
                if (empName.includes(query)) return true;
                
                const empWords = empName.split(' ');
                const queryWords = query.split(' ');
                
                return queryWords.some(qWord => 
                    empWords.some(empWord => empWord.includes(qWord))
                );
            });
            
            if (employee) {
                displayEmployeeSearchResult(employee);
            } else {
                displayNotFoundMessage(searchQuery);
            }
        }
        
        // عرض نتيجة بحث الموظف
        function displayEmployeeSearchResult(employee) {
            const attendance = employee.attendance || [];
            const totalHours = attendance.reduce((sum, day) => sum + (day.totalHours || 0), 0);
            
            let attendanceTable = '';
            if (attendance.length > 0) {
                attendanceTable = `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <thead>
                            <tr style="background-color: var(--primary-color); color: white;">
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">التاريخ</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">وقت الحضور</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">وقت الانصراف</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">عدد الساعات</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                attendance.forEach(day => {
                    attendanceTable += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${day.date || '-'}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${day.checkIn || '-'}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${day.checkOut || '-'}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: var(--primary-color);">${formatHours(day.totalHours || 0)}</td>
                    </tr>
                `;
            });

                attendanceTable += `
                                </tbody>
                            </table>
                `;
            }
            
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = `
                <div class="search-result-card">
                    <h3><i class="fas fa-user"></i> ${employee.name}</h3>
                    <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; font-size: 1.1rem;">
                        <span style="color: var(--primary-color); font-weight: bold;">إجمالي أيام العمل: ${attendance.length} يوم</span>
                        <span style="color: var(--primary-color); font-weight: bold;">مجموع الساعات: ${formatHours(totalHours)}</span>
                        </div>
                    ${attendanceTable}
                </div>
            `;
        }
        
        // عرض رسالة عدم العثور على النتيجة
        function displayNotFoundMessage(searchQuery) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = `
                <div class="not-found-message">
                    <h3><i class="fas fa-exclamation-triangle"></i> لم يتم العثور على النتيجة</h3>
                    <p>عذراً، لم يتم العثور على موظف باسم "<strong>${searchQuery}</strong>"</p>
                    <div class="contact-info">
                        <h4><i class="fas fa-info-circle"></i> للمساعدة والاستفسار:</h4>
                        <p><i class="fas fa-building"></i> <strong>مكتب شؤون العاملين</strong></p>
                        <p><i class="fab fa-whatsapp"></i> <a href="https://wa.me/962921218781" class="whatsapp-link" target="_blank">واتساب: 0921218781</a></p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>